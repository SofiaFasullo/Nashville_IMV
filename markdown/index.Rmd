---
title: "Nashville Venues Project Data Portal"
author: "Michael Fichman & Sofia Fasullo for PennPraxis"
date: "8/29/2023"
output:
  html_document:
    toc: yes
    toc_float: yes
    theme: cosmo
    code_folding: hide
    code_download: no
  pdf_document:
    toc: yes
---


NOTES AND TO-DO's:

- Write a methodology section (Sofia)
- Associate license data with venues in a separate script (Sofia)
- Incorporate that script into the data_markdown script (Michael)
- Annotate maps and charts, put proper text and styling (Sofia)
- Add property condition, year built, building use and other data in the data_markdown (Michael) DONE
- Add capacity data and re-run data_markdown (TBD - ??)
- Do some comparisons with CFP database (Michael)
- Write top takeaways (Michael)
- Analyze recent sales values and impart risk scores (Michael) - DONE
- Create some general census maps, tables, figures to illustrate economic geography in Nashville and changes - this will be done as needed during the writing process (Sofia)



```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# ---- Load Packages ----
#list of packages


library(tidyverse)
library(data.table)
library(sf)
library(viridis)
library(viridisLite)
#library(translateR)
library(kableExtra)
library(leaflet)
library(leaflet.extras)
library(lubridate)
library(mapview)
library(DT)

# ---- Load Graphic Palettes ----

# Load a ggplot theme and a color palette

plotTheme <- theme(
  plot.title =element_text(size=12),
  plot.subtitle = element_text(size=8),
  plot.caption = element_text(size = 6),
  axis.text.x = element_text(size = 10, angle = 45, hjust = 1),
  axis.text.y = element_text(size = 10),
  axis.title.y = element_text(size = 10),
  # Set the entire chart region to blank
  panel.background=element_blank(),
  plot.background=element_blank(),
  #panel.border=element_rect(colour="#F0F0F0"),
  # Format the grid
  panel.grid.major=element_line(colour="#D0D0D0",size=.75),
  axis.ticks=element_blank())

mapTheme <- theme(plot.title =element_text(size=12),
                  plot.subtitle = element_text(size=8),
                  plot.caption = element_text(size = 6),
                  axis.line=element_blank(),
                  axis.text.x=element_blank(),
                  axis.text.y=element_blank(),
                  axis.ticks=element_blank(),
                  axis.title.x=element_blank(),
                  axis.title.y=element_blank(),
                  panel.background=element_blank(),
                  panel.border=element_blank(),
                  panel.grid.major=element_line(colour = 'transparent'),
                  panel.grid.minor=element_blank(),
                  legend.direction = "vertical", 
                  legend.position = "right",
                  plot.margin = margin(1, 1, 1, 1, 'cm'),
                  legend.key.height = unit(1, "cm"), legend.key.width = unit(0.2, "cm"))

palette <- c("#10142A", "#47E9B9", "#F55D60", "#71EA48", "#C148EA", "#EAC148")
viridisPalette <- c("#440154", "#73D055", "#F55D60", "#238A8D", "#FDE725")
CityPalette <- c("#A230C2", "#3AEAB8", "#F9C700", "#0069FC", "#EF3340", "#bdbdbd") # Berlin, NYC, Tokyo, Stockholm, Montreal, Sydney
```

```{r load_cfp_data, message=FALSE, warning=FALSE, results = 'hide'}

# LOAD IN THE CFP DATA FOR COMPARISONS

# Read in district aggregates
d1_aggregates <- st_read("~/GitHub/CFP/unified__city_data/district_aggregates/d1_aggregates_11_16_22.geojson") %>%
  st_as_sf(crs = 4326)

d2_aggregates <- st_read("~/GitHub/CFP/unified__city_data/district_aggregates/d2_aggregates_06_15_23.geojson") %>%
  st_as_sf(crs = 4326) %>%
  rename(d2_name = d2_name.x)


# Read in venues
main_venue_data <- read.csv("~/GitHub/CFP/unified__city_data/main_venue_data_final_testSydney.csv") %>%
  mutate(city = ifelse(city == "Solna", "Stockholm", city))

# Read in EPSG information

source("~/GitHub/CFP/unified__city_data/epsg_list.R")


```

```{r load_nash_data, message=FALSE, warning=FALSE, results = 'hide'}

# LOAD IN THE NASH DATA

# Read in district aggregates
d1_aggregates_nash <- st_read("~/GitHub/Nashville_IMV/data/venue_tables/to_map/d1_aggregate_v5.geojson") %>%
  st_as_sf(crs = 4326) %>%
  rename(venue_count = num_venues,
         d1_name = Communit_1)

d2_aggregates_nash <- st_read("~/GitHub/CFP/unified__city_data/district_aggregates/d2_aggregates_06_15_23.geojson") %>%
  st_as_sf(crs = 4326) %>%
  rename(d2_name = d2_name.x)


# Read in venues - THIS IS THE FILEPATH IN Data_Markdown.Rmd as of 7/18/2023
nash_venue_data <- st_read("~/GitHub/Nashville_IMV/data/venue_tables/to_map/venues_v4.geojson") %>%
  st_transform(crs = 4326) %>%
  group_by(name) %>%
  slice(1) %>%
  ungroup() %>%
  mutate(x=map_dbl(geometry, ~st_centroid(.x)[[1]]),
         y=map_dbl(geometry, ~st_centroid(.x)[[2]])) %>%
  mutate(X = row_number()) %>%
  as.data.frame()


```

```{r create_basemaps}
library(ggmap)


ll <- function(dat, proj4 = 4326){
st_transform(dat, proj4)
}
```

```{r message = FALSE}
base_map1 <-get_stamenmap(bbox = unname(st_bbox(ll(st_buffer(st_centroid(d1_aggregates_nash),10000)))),
                    force = TRUE, maptype = "toner-lite", zoom = 11)

```

```{r functions, include=FALSE}
#function to calculate the distribution of values in any given column with the option to group by another column
calculate_share <- function(dat, col, facetCol = "") {
  if(facetCol != ""){
    dat <- dat %>%
                  group_by(!!sym(col), !!sym(facetCol)) %>% 
                  summarise(count = n()) %>% 
                  group_by(!!sym(facetCol)) %>%
                  mutate(share = count/sum(count)*100)
  }
  else {
    dat <- dat %>% 
                  group_by(!!sym(col)) %>% 
                  summarize(count = n()) %>% 
                  mutate(share = count/sum(count)*100)
  }
  return(dat)
}
```

# 1. Key Takeaways

- IMVs are in spaces valued at far less per sqft than non-IMVs
- IMVs are doing more experimental programming
- IMVs are more community-focused on average
- IMVs are more likely to promote lineups and artists in their marketing
- IMVS are less likely to use their space for non-music programs and uses
- About X% of music spaces in Nashville are "Occasional" music spaces - with programming focused on other types of business and/or infrequent events
- Spaces with lower land values are investing more in community-oriented and experimental programming (IMV or not)
- Researchers and community members identified 253 spaces used for music in Nashville on a periodic or regular basis.

# 2. Data Sources

- IMV data set

- Chamber of Commerce Data (link)

- US Census

- Nashville Metro Cadastral

- Nashville Metro Parcels, Property Characteristics

- Nashville Metro Fire Inspection Data

- Nashville Planning Districts

# 3. Methods

What did we do?

We collected the data set with liaisons, community members and desk research (this will be covered by VL in the report)

We related each venue to it's APN number (a property identifier) and joined it to tax records, license records.

We created variables for knn sq ft costs, dist to CBD centroid, joined venues to districts

# 4. Venue Database

Let's give descriptive statistics for the venue database

Searchable database

```{r}
datatable(nash_venue_data, 
          options = list(pageLength = 10))
```

## 4.1. Total number of venues

- How many venues

```{r}
nrow(nash_venue_data)

```

### 4.1.2. Number of IMVs


What is a dedicated music venue?  What is an independent music venue?

A music space - 
More than 1 show per week (5+ per month), is live music the purpose rated "somewhat likely" or "very likely"

```{r}
nash_venue_data %>%
  group_by(music_space) %>%
  tally()

```

```{r}
nash_venue_data %>%
  group_by(music_space, IMV) %>%
  tally()

```

## 4.2. Venue locations

Music spaces

```{r}
ggplot()+
    geom_sf(data = d1_aggregates_nash,
          fill = '#f0f0f0', 
          color = 'white')+
  geom_point(data = nash_venue_data,
             aes(x = x, y = y, color = music_space),
             alpha = 0.3, size = 1)+
  mapTheme

```

Music spaces by indepenence

```{r}
ggplot()+
    geom_sf(data = d1_aggregates_nash,
          fill = '#f0f0f0', 
          color = 'white')+
  geom_point(data = nash_venue_data %>%
               filter(music_space == "Music Space"),
             aes(x = x, y = y),
             alpha = 0.3, size = 1)+
  facet_wrap(~IMV)+
  mapTheme

```

### 4.2.1. Interactive Map 

```{r leaflet, message= FALSE, warning=FALSE, eval = FALSE}

l <- leaflet() %>% 
  addProviderTiles(providers$Esri.WorldTopoMap) %>%
  setView(lng = mean(nash_venue_data$x, na.rm = TRUE),
          lat = mean(nash_venue_data$y, na.rm = TRUE),
          zoom = 10) %>%
  addScaleBar(position = "topleft") %>%
  addCircleMarkers(data= nash_venue_data,
                   lng=~x, 
                   lat=~y,
                   radius =~ 1, 
                   fillOpacity =~ 1,
                   color =~ "blue",
                   label=~paste(name, address_admin, IMV))

l

```

```{r}
nash_venue_data %>%
  st_as_sf(coords = c("x","y"), 
           crs= 4326) %>%
  filter(music_space == "Music Space") %>%
  select(name, address_admin, APN, IMV, ownership_structure, independent_booking, capacity, TotlAppr) %>%
  mapView(., zcol = "IMV")

```
### 4.2.2. Heat map (ggplot)

This is JUST  FOR MUSIC SPACES, does not include occasional music spaces

```{r make_fishnet}
fishnet <- st_make_grid(d1_aggregates_nash %>%
                          st_transform(crs = 2274), 
                        cellsize = 5280) %>% #size in feet - half mile
  st_sf() %>%
  st_transform(crs = 4326)

fishnet <- fishnet[d1_aggregates_nash %>%
                          st_transform(crs = 4326),] %>%
  mutate(uniqueID = rownames(.)) %>%
  select(uniqueID) %>%
  mutate(lon=map_dbl(geometry, ~st_centroid(.x)[[1]]),
         lat=map_dbl(geometry, ~st_centroid(.x)[[2]]))

# Join the fishet to the points

fishnet <- st_join(fishnet, 
                nash_venue_data %>%
                  filter(is.na(x)== FALSE,
                         is.na(y)== FALSE) %>%
                  filter(music_space == "Music Space") %>%
                  st_as_sf(coords = c("x", "y"), crs = 4326), 
                join = st_intersects, 
                left = TRUE) %>%
  select(uniqueID, X) %>%
  group_by(uniqueID) %>% 
  summarise(n_venues = n_distinct(X, na.rm = TRUE)) %>%
  #mutate(n = ifelse(n == 1, 0, n)) %>%
  #rename(n_venues = n) %>%
  as.data.frame() %>%
  select(-geometry) %>%
  left_join(fishnet, .)
```

```{r fishnet_map, warning = FALSE, message = FALSE}

# Make sure you set the labels here to reflect the actual max density by cell

max(fishnet$n_venues)

ggplot()+
  geom_sf(data = d1_aggregates_nash,
          fill = '#f0f0f0', 
          color = 'white')+
  geom_sf(data = fishnet %>%
            filter(n_venues >0), 
          aes(fill = n_venues),
          color = "transparent",
          alpha = 0.4)+
  scale_fill_viridis('VENUES/\nmi^2', direction = -1,
                     limits=c(1,max(fishnet$n_venues)), breaks=c(1, max(fishnet$n_venues)),
                     labels=c("1",max(fishnet$n_venues)))+
  labs(
    title = "VENUE DENSITY - Nashville, 2023",
    subtitle = "",
    caption = "Data: PennPraxis, Metro Nashville")+
  mapTheme
```

```{r fishnet_w_basemap}
ggmap(base_map1) +
 geom_sf(data = ll(fishnet %>%
            filter(n_venues >0)),
            inherit.aes = TRUE,
          aes(fill = n_venues),
          color = "transparent",
          alpha = 0.4)+
  scale_fill_viridis('VENUES/\nmi^2', direction = -1,
                     limits=c(1,max(fishnet$n_venues)), breaks=c(1, max(fishnet$n_venues)),
                     labels=c("1",max(fishnet$n_venues)))+
  labs(
    title = "VENUE DENSITY - Nashville / Davidson County, 2023",
    subtitle = "",
    caption = "Data: PennPraxis, Metro Nashville")+
  mapTheme
```

### 4.2.3. Point Map (static)


### 4.2.4. Map by Planning District (count)

TO DO ONCE d1_aggregates_nash is set


## 4.3. IMV Status

## 4.3.1. Independent Ownership

```{r}
ggplot(data = nash_venue_data %>%
         filter(is.na(ownership_structure) == FALSE))+
  geom_bar(aes(ownership_structure), fill = CityPalette[6], alpha = 0.6, size = 3)+
  #scale_fill_viridis_d()+
  labs(
    title = "Q: Is the venue independently owned and operated?",
    subtitle = "Independence - no association with another business through common ownership\n or affiliation (sharing of employees, resources, branding etc.,)",
    x="",
    y="Total Venues",
    caption = "Data: PennPraxis")+
  facet_wrap(~music_space)+
  plotTheme
```

## 4.3.2. Corporate Function

```{r}
ggplot(data = nash_venue_data %>%
         filter(is.na(independent_booking) == FALSE))+
  geom_bar(aes(independent_booking), fill = CityPalette[6], alpha = 0.6, size = 3)+
  #scale_fill_viridis_d()+
  labs(
    title = "Are booking or promotion contracted to corporate partners? ",
    subtitle = "",
    x="",
    y="Total Venues",
    caption = "Data: PennPraxis")+
  facet_wrap(~music_space)+
  plotTheme
```

```{r}
ggplot(data = nash_venue_data)+
  geom_bar(aes(IMV), fill = CityPalette[6], alpha = 0.6, size = 3)+
  #scale_fill_viridis_d()+
  labs(
    title = "IMV Status",
    subtitle = "Independent Ownership Structure and Independent Booking & Promotion",
    x="",
    y="Total Venues",
    caption = "Data: PennPraxis")+
  facet_wrap(~music_space)+
  coord_flip()+
  plotTheme
```

## 4.4. Capacity

### 4.4.1. Histogram of capacity

NOTE - These data are not complete as of 9/5 - we are awaiting data from Nash FD - these are data from the Chamber's study several years ago.

```{r community_histogram}
ggplot(data = nash_venue_data %>%
         mutate(capacity = as.numeric(capacity)) %>%
         filter(capacity < 5000))+
  geom_histogram(aes(capacity), fill = CityPalette[6], alpha = 0.6, binwidth = 250)+
  #scale_fill_viridis_d()+
  labs(
    title = "Capacity",
    subtitle = "Capacities Over 5000 are removed",
    x="",
    y="Occupants",
    #fill = "CFP City",
    caption = "Data: Nashville Fire Dept")+
  plotTheme

```

### 4.4.2. Capacity by IMV status

```{r}
ggplot(data = nash_venue_data %>%
         mutate(capacity = as.numeric(capacity)) %>%
         filter(capacity < 5000) )+
  geom_histogram(aes(capacity), fill = CityPalette[6], alpha = 0.6, binwidth = 250)+
  #scale_fill_viridis_d()+
  labs(
    title = "Capacity",
    subtitle = "Capacities Over 5000 are removed",
    x="",
    y="Occupants",
    #fill = "CFP City",
    caption = "Data: Nashville Fire Dept")+
  facet_wrap(~IMV)+
  plotTheme
```

There is still a ton of missing capacity data as of 8/16 - MF

```{r}
nash_venue_data %>%
         mutate(capacity = as.numeric(capacity)) %>%
  group_by(IMV) %>%
  summarize(total_capacity = sum(capacity, na.rm = TRUE),
            median_capacity = median(capacity, na.rm = TRUE)) %>%
  kable() %>%
  kable_styling()

```

### 4.4.3. Geography of Occupancy

- Map of occupancies (e.g. occupant load per fishnet cell or per planning area)

## 4.5. Venue Age

```{r}

ggplot(nash_venue_data )+
  geom_bar(aes(years_operating), fill = CityPalette[6], alpha = 0.6, size = 3)+
  #scale_fill_viridis_d()+
  labs(
    title = "Years Operating",
    subtitle = "",
    x="",
    y="Total Venues",
    caption = "Data: PennPraxis")+
  plotTheme

```

```{r}

ggplot(nash_venue_data )+
  geom_bar(aes(years_operating), fill = CityPalette[6], alpha = 0.6, size = 3)+
  #scale_fill_viridis_d()+
  labs(
    title = "Years Operating",
    subtitle = "",
    x="",
    y="Total Venues",
    caption = "Data: PennPraxis")+
  facet_grid(music_space~IMV)+
  plotTheme

```

```{r}

ggplot(nash_venue_data %>%
         filter(music_space == "Music Space"))+
  geom_bar(aes(years_operating, fill = IMV), position = "dodge", alpha = 0.6, size = 3)+
  #scale_fill_viridis_d()+
  labs(
    title = "Years Operating",
    subtitle = "",
    x="",
    y="Total Venues",
    caption = "Data: PennPraxis")+
  plotTheme

```

## 4.6. Events Per Month

```{r}

ggplot(nash_venue_data)+
  geom_bar(aes(events_per_month), fill = CityPalette[6], alpha = 0.6, size = 3)+
  #scale_fill_viridis_d()+
  labs(
    title = "Events Per Month - All Spaces",
    subtitle = "",
    x="",
    y="Total Venues",
    caption = "Data: PennPraxis")+
  plotTheme

ggplot(nash_venue_data %>%
        filter(music_space == "Music Space"))+
  geom_bar(aes(events_per_month), fill = CityPalette[6], alpha = 0.6, size = 3)+
  #scale_fill_viridis_d()+
  labs(
    title = "Events Per Month, Music Spaces",
    subtitle = "",
    x="",
    y="Total Venues",
    caption = "Data: PennPraxis")+
  facet_wrap(~IMV)+
  plotTheme

```

## 4.7. Artist Payment

This data isn't any good - scrapping this

## 4.6. Programming

- Bar plots of programming variables (facetted by indie/non)

### 4.6.1. Experimentation

There is a bi-modal effect with experimentation, it's either very experimental or not at all.

Maybe a better question is - what percentage of spaces are consider likely to offer experimental content between IMV/Non/Quasi?

Answer - roughly 40%, higher than Quasi and non-IMV

```{r}

ggplot(nash_venue_data %>%
         filter(music_space == "Music Space"))+
  geom_bar(aes(experimentation), fill = CityPalette[6], alpha = 0.6, size = 3)+
  #scale_fill_viridis_d()+
  labs(
    title = "Experimentation Likelihood - Music Spaces",
    subtitle = "Q: Compared to other venues in the city: Is this venue a platform for niche or experimental trends, sounds and art forms? Is it a place for experimental performers or extraordinary event concepts?",
    x="",
    y="Total Venues",
    caption = "Data: PennPraxis")+
  plotTheme
```


```{r}
ggplot(nash_venue_data %>%
         filter(music_space == "Music Space"))+
  geom_bar(aes(experimentation), fill = CityPalette[6], alpha = 0.6, size = 3)+
  #scale_fill_viridis_d()+
  labs(
    title = "Experimentation Likelihood",
    subtitle = "Q: Compared to other venues in the city: Is this venue a platform for niche or experimental trends, sounds and art forms? Is it a place for experimental performers or extraordinary event concepts?",
    x="",
    y="Total Venues",
    caption = "Data: PennPraxis")+
  facet_wrap(~IMV)+
  plotTheme

```

On average, IMVs are slightly more experimental

```{r}
nash_venue_data %>%
  group_by(IMV, music_space) %>%
  summarize(mean_experimentation = mean(experimentation_ord, na.rm = TRUE),
            n = n()) %>%
  arrange(music_space) %>%
  kable()


```

```{r}
nash_venue_data %>%
  filter(music_space == "Music Space") %>%
  group_by(IMV, experimentation) %>%
  tally() %>%
  mutate(pct = 100*(n/sum(n))) %>%
  kable()


```

### 4.6.2. Music as Main Purpose

```{r}

ggplot(nash_venue_data)+
  geom_bar(aes(purpose), fill = CityPalette[6], alpha = 0.6, size = 3)+
  #scale_fill_viridis_d()+
  labs(
    title = "Main Purpose",
    subtitle = "Q: Is the music program the main purpose why people attend this venue, and not e.g. food, drink, products?",
    x="",
    y="Total Venues",
    caption = "Data: PennPraxis")+
  plotTheme

ggplot(nash_venue_data)+
  geom_bar(aes(purpose), fill = CityPalette[6], alpha = 0.6, size = 3)+
  #scale_fill_viridis_d()+
  labs(
    title = "Main Purpose",
    subtitle = "Q: Is the music program the main purpose why people attend this venue, and not e.g. food, drink, products?",
    x="",
    y="Total Venues",
    caption = "Data: PennPraxis")+
  facet_wrap(~IMV)+
  plotTheme

```


### 4.6.3. Interdisciplinarity

```{r}

ggplot(nash_venue_data )+
  geom_bar(aes(interdisciplinarity), fill = CityPalette[6], alpha = 0.6, size = 3)+
  #scale_fill_viridis_d()+
  labs(
    title = "Interdisciplinarity",
    subtitle = "Q: Does the venue offer events for non-music presentations, such visual art, performing art, panel discussions or film screenings?",
    x="",
    y="Total Venues",
    caption = "Data: PennPraxis")+
  facet_wrap(~music_space)+
  plotTheme

```

```{r}
ggplot(nash_venue_data %>%
         filter(music_space == "Music Space"))+
  geom_bar(aes(interdisciplinarity), fill = CityPalette[6], alpha = 0.6, size = 3)+
  #scale_fill_viridis_d()+
  labs(
    title = "Interdisciplinarity",
    subtitle = "Q: Does the venue offer events for non-music presentations, such visual art, performing art, panel discussions or film screenings?",
    x="",
    y="Total Venues",
    caption = "Data: PennPraxis")+
  facet_wrap(~IMV)+
  plotTheme

```


```{r}
nash_venue_data %>%
  group_by(IMV, music_space) %>%
  summarize(mean_interdisciplinarity = mean(interdisciplinarity_ord, na.rm = TRUE),
            n = n()) %>%
  arrange(music_space) %>%
  kable()


```

### 4.6.4. Community Focus


```{r}

ggplot(nash_venue_data %>%
         filter(music_space == "Music Space"))+
  geom_bar(aes(community_focus), fill = CityPalette[6], alpha = 0.6, size = 3)+
  #scale_fill_viridis_d()+
  labs(
    title = "Community Focus - Music Spaces",
    subtitle = "Q: Is the venue likely to be any of the following... a consistent platform for a niche genre, a space for underrepresented communities or music scenes, a neighbourhood community hub, and not e.g. walk in tourists?",
    x="",
    y="Total Venues",
    caption = "Data: PennPraxis")+
  plotTheme

```


```{r}
ggplot(nash_venue_data %>%
         filter(music_space == "Music Space"))+
  geom_bar(aes(community_focus), fill = CityPalette[6], alpha = 0.6, size = 3)+
  #scale_fill_viridis_d()+
  labs(
    title = "Community Focus - Music Spaces",
    subtitle = "Q: Is the venue likely to be any of the following... a consistent platform for a niche genre, a space for underrepresented communities or music scenes, a neighbourhood community hub, and not e.g. walk in tourists?",
    x="",
    y="Total Venues",
    caption = "Data: PennPraxis")+
  facet_wrap(~IMV)+
  plotTheme

```

Indie venues ARE more local

```{r}
nash_venue_data %>%
  group_by(IMV, music_space) %>%
  summarize(mean_community_focus = mean(community_focus_ord, na.rm = TRUE),
            n = n()) %>%
  arrange(music_space) %>%
  kable()


```

```{r}
nash_venue_data %>%
  filter(music_space == "Music Space") %>%
  group_by(IMV, community_focus) %>%
  tally() %>%
  mutate(pct = 100*(n/sum(n))) %>%
  kable()


```

```{r}
nash_venue_data %>%
  filter(music_space == "Music Space") %>%
  mutate(likely_community_focus = ifelse(str_detect(community_focus, "Somewhat") |
                                           str_detect(community_focus, "Very"),
                                         "Somewhat or Very Likely Community Focus",
                                         "Not At All or Not too Likely")) %>%
  group_by(IMV, likely_community_focus) %>%
  tally() %>%
  mutate(pct = 100*(n/sum(n))) %>%
  kable()


```


### 4.6.5. Promoting Events


```{r}

ggplot(nash_venue_data %>%
         filter(music_space == "Music Space"))+
  geom_bar(aes(event_promotion), fill = CityPalette[6], alpha = 0.6, size = 3)+
  #scale_fill_viridis_d()+
  labs(
    title = "Promoting Artistic Content - Music Spaces",
    subtitle = "Q: Is the promotion and marketing of this space focused on artistic content (artists, lineups, performances)?",
    x="",
    y="Total Venues",
    caption = "Data: PennPraxis")+
  plotTheme

```


```{r}
ggplot(nash_venue_data %>%
         filter(music_space == "Music Space"))+
  geom_bar(aes(event_promotion), fill = CityPalette[6], alpha = 0.6, size = 3)+
  #scale_fill_viridis_d()+
  labs(
    title = "Promoting Artistic Content",
    subtitle = "Q: Is the promotion and marketing of this space focused on artistic content (artists, lineups, performances)?",
    x="",
    y="Total Venues",
    caption = "Data: PennPraxis")+
  facet_wrap(~IMV)+
  plotTheme

```
```{r}
nash_venue_data %>%
  group_by(IMV, music_space) %>%
  summarize(mean_event_promotion = mean(event_promotion_ord, na.rm = TRUE),
            n = n()) %>%
  arrange(music_space) %>%
  kable()


```

## 4.7. CFP Comparisons

- How do some important metrics compare to other cities in CFP database?

# 5. Venues and The City

- Venue zoning districts (bar plot)

- Median sqft cost by neighborhood

- IMVs with the highest sq ft cost

## 5.1. Venues and real estate costs

```{r}
nash_venue_data %>%
  filter(music_space == "Music Space") %>%
  mutate(value_sqft = TotlAppr/Area_sqft) %>%
  filter(value_sqft < 1000) %>%
  ggplot()+
  geom_histogram(aes(value_sqft), binwidth = 50) +
  facet_wrap(~IMV)+
  plotTheme

```

```{r}
nash_venue_data %>%
  filter(music_space == "Music Space") %>%
  mutate(value_sqft = TotlAppr/Area_sqft) %>%
  group_by(IMV) %>%
  summarize(median_sqft = median(value_sqft))

```

```{r}
nash_venue_data %>%
  filter(music_space == "Music Space") %>%
  mutate(value_sqft = TotlAppr/Area_sqft) %>%
  group_by(experimentation) %>%
  summarize(median_value_sqft = median(value_sqft, na.rm = TRUE)) %>%
  ggplot()+
  geom_bar(aes(x = experimentation, y = median_value_sqft), stat = "identity")+
  plotTheme

```

```{r}
nash_venue_data %>%
  filter(music_space == "Music Space") %>%
  mutate(value_sqft = TotlAppr/Area_sqft) %>%
  group_by(community_focus) %>%
  summarize(median_value_sqft = median(value_sqft, na.rm = TRUE)) %>%
  ggplot()+
  geom_bar(aes(x = community_focus, y = median_value_sqft), stat = "identity")+
  plotTheme

```

```{r}
nash_venue_data %>%
  filter(music_space == "Music Space") %>%
  mutate(value_sqft = TotlAppr/Area_sqft) %>%
  group_by(interdisciplinarity) %>%
  summarize(median_value_sqft = median(value_sqft, na.rm = TRUE)) %>%
  ggplot()+
  geom_bar(aes(x = interdisciplinarity, y = median_value_sqft), stat = "identity")+
  plotTheme

```

Seems like IMVs and non-IMVs program similarly in practice vis-a-vis these measures... ON AVERAGE

What about the exceptional examples??

No - it's basically the same!

```{r}
nash_venue_data %>%
  filter(music_space == "Music Space") %>%
  mutate(programming_sum = interdisciplinarity_ord + experimentation_ord +
           community_focus_ord + event_promotion_ord) %>%
  ggplot()+
  geom_histogram(aes(programming_sum), binwidth = 1)+
  facet_wrap(~IMV)+
  plotTheme

```

MF - what are these indies with the super high sq footage values?

```{r}
nash_venue_data %>%
  filter(music_space == "Music Space") %>%
  mutate(programming_sum = interdisciplinarity_ord + experimentation_ord +
           community_focus_ord + event_promotion_ord) %>%
  mutate(value_sqft = TotlAppr/Area_sqft) %>%
  filter(value_sqft < 1000) %>%
  ggplot()+
  geom_point(aes(y = programming_sum, x = value_sqft, color = IMV))+
  geom_smooth(aes(y = programming_sum, x = value_sqft), method = "lm", se = FALSE)+
  plotTheme

```


```{r}
nash_venue_data %>%
  filter(music_space == "Music Space") %>%
  mutate(programming_sum = interdisciplinarity_ord + experimentation_ord +
           community_focus_ord + event_promotion_ord) %>%
  mutate(value_sqft = TotlAppr/Area_sqft) %>%
  filter(value_sqft < 1000) %>%
  ggplot()+
  geom_point(aes(y = programming_sum, x = value_sqft))+
  geom_smooth(aes(y = programming_sum, x = value_sqft), method = "lm", se = FALSE)+
  facet_wrap(~IMV)+
  plotTheme

```

## 5.2. Zoning and Land Use


```{r}
nash_venue_data %>%
  group_by(ZONE_DESC) %>%
  tally() %>%
  arrange(-n)

```

## 5.3. Building Age

```{r}
nash_venue_data %>%
  filter(music_space == "Music Space") %>%
  ggplot()+
  geom_histogram(aes(YearBuilt), binwidth = 10)+
  facet_wrap(~IMV)+
  plotTheme
  

```

## 5.4. Building Condition



## 5.5.  Venues by planning area / neighborhood

All music spaces

```{r venues_total_map}
ggplot()+
  geom_sf(data = d1_aggregates_nash, fill = 'transparent', 
          color = 'grey')+
  geom_sf(data = d1_aggregates_nash %>%
            filter(is.na(num_music_smaces) == FALSE),
          aes(fill = num_music_smaces),
          color = 'grey', alpha = 0.6)+
  scale_fill_viridis('Music Spaces', direction = -1, alpha = 0.8)+
  geom_text(data = d1_aggregates_nash %>%
              filter(venue_count != 0) %>%
              mutate(lon=map_dbl(geometry, ~st_centroid(.x)[[1]]),
                     lat=map_dbl(geometry, ~st_centroid(.x)[[2]])),
            aes(x = lon, y = lat, label = d1_name),
            color = "black", size = 3)+
  mapTheme

```

```{r venues_full_indie_map}
ggplot()+
  geom_sf(data = d1_aggregates_nash, fill = 'transparent', 
          color = 'grey')+
  geom_sf(data = d1_aggregates_nash %>%
            filter(is.na(IMV_n) == FALSE),
          aes(fill = IMV_n),
          color = 'grey', alpha = 0.6)+
  scale_fill_viridis('IMVs', direction = -1, alpha = 0.8)+
  geom_text(data = d1_aggregates_nash %>%
              filter(venue_count != 0) %>%
              mutate(lon=map_dbl(geometry, ~st_centroid(.x)[[1]]),
                     lat=map_dbl(geometry, ~st_centroid(.x)[[2]])),
            aes(x = lon, y = lat, label = d1_name),
            color = "black", size = 3)+
  mapTheme

```

```{r venues_quasi_indie_map}
ggplot()+
  geom_sf(data = d1_aggregates_nash, fill = 'transparent', 
          color = 'grey')+
  geom_sf(data = d1_aggregates_nash %>%
            filter(is.na(Quasi_IMV_n) == FALSE),
          aes(fill = Quasi_IMV_n),
          color = 'grey', alpha = 0.6)+
  scale_fill_viridis('Quasi IMVs', direction = -1, alpha = 0.8)+
  geom_text(data = d1_aggregates_nash %>%
              filter(venue_count != 0) %>%
              mutate(lon=map_dbl(geometry, ~st_centroid(.x)[[1]]),
                     lat=map_dbl(geometry, ~st_centroid(.x)[[2]])),
            aes(x = lon, y = lat, label = d1_name),
            color = "black", size = 3)+
  mapTheme

```

- Surface map of real estate values by square foot with indie venues on top (this is found later)

- k=5 mean square footage costs of recent sales (inflation adjusted) for indies

- Comparison to CFP cities - programming and real estate relationships

- Programming, cost and relationship to distance to CBD

- Venue age by district - where are the young and old venues?

- CFP indicators maps

```{r experimentation}
ggplot()+
  geom_sf(data = d1_aggregates_nash, fill = 'transparent', 
          color = 'grey')+
  geom_sf(data = d1_aggregates_nash %>%
            filter(is.na(experimentation) == FALSE),
          aes(fill = experimentation),
          color = 'grey', alpha = 0.6)+
  scale_fill_viridis('Mean Experimental\nContent Score', direction = -1)+
  geom_text(data = d1_aggregates_nash %>%
              filter(venue_count != 0) %>%
              mutate(lon=map_dbl(geometry, ~st_centroid(.x)[[1]]),
                     lat=map_dbl(geometry, ~st_centroid(.x)[[2]])),
            aes(x = lon, y = lat, label = d1_name),
            color = "black", size = 3)+
  mapTheme

```

```{r community_map}
ggplot()+
  geom_sf(data = d1_aggregates_nash, fill = 'transparent', 
          color = 'grey')+
  geom_sf(data = d1_aggregates_nash %>%
            filter(is.na(community_focus) == FALSE),
          aes(fill = community_focus),
          color = 'grey', alpha = 0.6)+
  scale_fill_viridis('Mean Community\nFocus Score', direction = -1)+
  geom_text(data = d1_aggregates_nash %>%
              filter(venue_count != 0) %>%
              mutate(lon=map_dbl(geometry, ~st_centroid(.x)[[1]]),
                     lat=map_dbl(geometry, ~st_centroid(.x)[[2]])),
            aes(x = lon, y = lat, label = d1_name),
            color = "black", size = 3)+
  mapTheme

```

```{r experimental_plot}

ggplot(data = d1_aggregates_nash %>%
         filter(is.na(experimentation) == FALSE) %>%
         as.data.frame() %>%
         mutate(venue_text = str_c(as.character(venue_count), " venues")) %>%
         select(venue_text, venue_count, experimentation, d1_name) %>%
         arrange(-experimentation) %>%
         top_n(10))+
  geom_bar(aes(x = reorder(toupper(d1_name), experimentation), 
               y= experimentation),
           stat = "identity", fill = CityPalette[6], width = 0.3,
           alpha = 0.8)+
  geom_text(aes(label = toupper(venue_text), x = toupper(d1_name), 
                y= experimentation / 2), alpha = 0.6, size = 4 )+
  labs(
    title = "DISTRICTS WITH HIGHEST EXPERIMENTAL CONTENT SCORES",
    #subtitle = "Labels indicate total number of districts in that ward",
    caption = "Data: PennPraxis")+
  ylab("MEAN EXPERIMENTAL CONTENT SCORE (SCALE OF 1-4)")+
  xlab("")+
  coord_flip()+
  plotTheme

```

```{r experimental_plot}

ggplot(data = d1_aggregates_nash %>%
         filter(is.na(community_focus) == FALSE) %>%
         as.data.frame() %>%
         mutate(venue_text = str_c(as.character(venue_count), " venues")) %>%
         select(venue_text, venue_count, community_focus, d1_name) %>%
         arrange(-community_focus) %>%
         top_n(10))+
  geom_bar(aes(x = reorder(toupper(d1_name), community_focus), 
               y= community_focus),
           stat = "identity", fill = CityPalette[6], width = 0.3,
           alpha = 0.8)+
  geom_text(aes(label = toupper(venue_text), x = toupper(d1_name), 
                y= community_focus / 2), alpha = 0.6, size = 4 )+
  labs(
    title = "DISTRICTS WITH HIGHEST COMMUNITY SCORES",
    #subtitle = "Labels indicate total number of districts in that ward",
    caption = "Data: PennPraxis")+
  ylab("MEAN COMMUNITY PROGRAM SCORE (SCALE OF 1-4)")+
  xlab("")+
  coord_flip()+
  plotTheme

```

# 6. Venues and Regulation

- What kind of licenses are associated with these venues?

- What about the ones that primarily hold shows (e.g. 10+ per month)

# 7. Venues and Threats

- What are the venues listed as threatened, where are they? (map) What are their characteristics?

```{r}
nash_venue_data %>%
  filter(threats_neighbors == 1 |
           threats_cost == 1 |
           threats_licensing == 1) %>%
  select(name, address_admin, APN, threats_neighbors, threats_cost, threats_licensing, Condition, TotlAssd) %>%
  kable() %>%
  kable_styling()
  
```

- What properties have the highest disparity between estimated square footage value and assessed value?

# 8. Change in Nashville

- Map of change in rents by census tract (over 10 years)

## 8.2. Property appraisal values for recent sales

- Price per sqft by grid cell in Nashville (based on cadastral data)

```{r}
parcels = st_read("~/Github/Nashville_IMV/data/metro/Nashville_Parcel_data.shp") %>% st_transform(4326)
```

Filtering non-zero sales since 2020, joining to fishnet and averaging sales price by sq footage

```{r}
fishnet_parcels <- st_make_grid(d1_aggregates_nash %>%
                          st_transform(crs = 2274), 
                        cellsize = 5280/2) %>% #size in feet - half mile
  st_sf() %>%
  st_transform(crs = 4326)

fishnet_parcels <- fishnet_parcels[d1_aggregates_nash %>%
                          st_transform(crs = 4326),] %>%
  mutate(uniqueID = rownames(.)) %>%
  select(uniqueID) %>%
  mutate(lon=map_dbl(geometry, ~st_centroid(.x)[[1]]),
         lat=map_dbl(geometry, ~st_centroid(.x)[[2]]))

# Join the fishet to the points

fishnet_parcels <- st_join(fishnet_parcels, 
                parcels %>%
                  filter(SalePrice > 0,
                         year(ymd(OwnDate))> 2020,
                         st_is_valid(.)) %>%
                  #sample_n(1000) %>%
                  mutate(lon=map_dbl(geometry, ~st_centroid(.x)[[1]]),
                         lat=map_dbl(geometry, ~st_centroid(.x)[[2]])) %>%
                  filter(is.na(lon)== FALSE,
                         is.na(lat)== FALSE) %>%
                  st_as_sf(coords = c("lon", "lat"), crs = 4326), 
                join = st_intersects, 
                left = TRUE) %>%
  select(uniqueID, TotlAppr, starea) %>%
  group_by(uniqueID) %>% 
  summarise(medianAppraisal = median(TotlAppr/starea, na.rm = TRUE),
            n_sales = n()) %>%
  #mutate(n = ifelse(n == 1, 0, n)) %>%
  #rename(n_venues = n) %>%
  as.data.frame() %>%
  select(-geometry) %>%
  left_join(fishnet_parcels, .)
```

```{r fishnet_map, warning = FALSE, message = FALSE}

# Make sure you set the labels here to reflect the actual max density by cell

max(fishnet_parcels$medianAppraisal)

ggplot()+
  geom_sf(data = fishnet_parcels %>%
            filter(is.na(medianAppraisal) == FALSE), 
          aes(fill = medianAppraisal),
          color = "transparent",
          alpha = 0.6)+
 scale_fill_viridis('Price sqft', direction = -1)+
  geom_sf(data = d1_aggregates_nash %>%
            st_transform(4326), fill = "transparent")+
  geom_point(data = nash_venue_data %>%
         filter(music_space == "Music Space") %>%
           filter(IMV == "Indep. Owned and Operated"),
             aes(x = x, y = y, color = IMV),
             size = 1.5,
             alpha = 0.5)+
  labs(
    title = "Median Appraised Value per Square Foot, Sales 2021-23",
    subtitle = "Half mile grid",
    caption = "Data: PennPraxis, Metro Nashville")+
  mapTheme
```

## 8.2.1. Venue exposure to real estate risk

Venue Appraised Value / sqft relative to median area appraisal (fishnet cell)

If the value is "above" the y = x line, that means the neighborhood square footage appraisal value of recent sales is higher than the square footage appraisal value of the building.

```{r}
nash_venue_data %>%
  mutate(value_sqft = TotlAppr/Area_sqft) %>%
  st_as_sf(coords = c("x", "y"), 
                              crs = 4269) %>%
                     st_transform(4326) %>%
  st_join(., fishnet_parcels) %>%
  filter(value_sqft < 1000) %>%
  filter(music_space == "Music Space") %>%
  ggplot()+
  geom_point(aes(x = value_sqft, medianAppraisal))+
  geom_abline(slope = 1)+
  facet_wrap(~IMV)+
  plotTheme

```

## 8.2.2. Risk indicators

Total area sales (half mile grid cell), appraised value, appraised value relative to area appraisal median (2021-23), IMV status, programming rating.

Formula:

Risk = sum of:

Quartile Value (amongst music spaces) of:
-Appraised Sqft Value
-Median value of appraisals in sales since 2021 w/in half mile
-Number of sales since 2021 w/in half mile
-Parcel appraised value as a pct of sqft value of sales w/in half mile

Plus:
-Physical condition (1 if average, 2 if fair, 4 if poor or very poor)
Community ranked Programming investment (e.g. experimentation, community focus 1 - 4)

WOULD LIKE TO ADD CAPACITY TO THIS

```{r}
risk_matrix <- nash_venue_data %>%
  filter(music_space == "Music Space") %>%
  mutate(value_sqft = TotlAppr/Area_sqft) %>%
  st_as_sf(coords = c("x", "y"), 
                              crs = 4269) %>%
                     st_transform(4326) %>%
  st_join(., fishnet_parcels) %>%
  mutate(appraisal_ratio = 100*(medianAppraisal/value_sqft)) %>%
  as.data.frame() %>%
  select(value_sqft, appraisal_ratio, experimentation_ord, community_focus_ord,
         name, address_admin, n_sales, medianAppraisal)%>%
  gather(-name, -address_admin, key = "variable", value = "value") %>%
  group_by(variable) %>%
  summarize(quantile = scales::percent(c(0.25, 0.5, 0.75)), 
            quartile = quantile(value, c(0.25, 0.5, 0.75), na.rm = TRUE)) %>%
  spread(quantile, quartile) %>% # join it back to the original data analysis
  left_join(., nash_venue_data %>%
  filter(music_space == "Music Space") %>%
  mutate(value_sqft = TotlAppr/Area_sqft) %>%
  st_as_sf(coords = c("x", "y"), 
                              crs = 4269) %>%
                     st_transform(4326) %>%
  st_join(., fishnet_parcels) %>%
  mutate(appraisal_ratio = 100*(medianAppraisal/value_sqft)) %>%
  mutate(programming_sum = experimentation_ord +
           community_focus_ord + event_promotion_ord) %>%
  as.data.frame() %>%
   select(value_sqft, appraisal_ratio, experimentation_ord, community_focus_ord,
         name, address_admin, n_sales, medianAppraisal)%>%
  gather(-name, -address_admin, key = "variable", value = "value"))%>% 
  mutate(quantile = case_when(value >= `75%` ~ 4,
                              value <= `25%` ~ 1,
                              value > `25%` & value < `50%` ~ 2,
                              value >= `50%` & value < `75%` ~ 3)) %>%
  select(-'25%', -'50%', -'75%') %>%
  group_by(name, address_admin, variable) %>%
  summarize(quantile = quantile) %>%
  pivot_wider(names_from = variable, values_from = quantile) %>%
  left_join(., nash_venue_data %>%
              filter(music_space == "Music Space") %>%
              select(IMV, name, address_admin, APN, music_space, Condition)) %>%
  mutate(Condition_ord = case_when(str_detect(Condition, "Poor") == TRUE ~ 4,
                                   str_detect(Condition, "Fair") == TRUE ~ 2,
                                   str_detect(Condition, "Average") == TRUE ~ 1,
                                   is.na(Condition) == TRUE ~ 1)) %>%
  mutate(cumulative_risk = sum(appraisal_ratio + value_sqft+ Condition_ord +
                                 experimentation_ord + community_focus_ord+ 
                                 medianAppraisal + n_sales, na.rm = TRUE))

```



- What are the areas of opportunity (e.g. can we ID relatively lower rent areas with high percentages of young adults, reasonable proximity to downtown?)

# 9. Maps for report

- Venue profile accompaniments (shows parcel and neighborhood context)

Here is an example - make a ggbasemap with a specific buffer area around the parcel (identified in the code by APN) and then just map the parcel.

```{r}
base_map_3rd_and_lindsley <-get_stamenmap(bbox = unname(st_bbox(ll(st_buffer(st_centroid(nash_venue_data %>%
                                                                                filter(name == "3rd & Lindsley") %>%
                                                                                  st_as_sf(coords = c("x", "y"), crs = 4269) %>% st_transform(4326)),
                                                                  300)))),
                    force = TRUE, maptype = "toner-lite", zoom = 16)
```

```{r}
ggmap(base_map_3rd_and_lindsley) +
 geom_sf(data = ll(nash_venue_data %>%
                     filter(name == "3rd & Lindsley") %>%
                     st_as_sf(coords = c("x", "y"), 
                              crs = 4269) %>%
                     st_transform(4326)),
            inherit.aes = FALSE, 
         color = "red",
         size = 2)+
  labs(
    title = "Focus Venue - 3rd and Lindsley",
    subtitle = "",
    caption = "Data: PennPraxis, Metro Nashville")+
  mapTheme
```

```{r}
ggmap(base_map_3rd_and_lindsley) +
 geom_sf(data = ll(right_join(parcels,
                             nash_venue_data %>%
                     filter(name == "3rd & Lindsley")) %>%
                     st_transform(4326)),
            inherit.aes = FALSE, 
         color = "red",
         fill = "red",
         alpha = 0.4)+
  labs(
    title = "Focus Venue - 3rd and Lindsley",
    subtitle = "",
    caption = "Data: PennPraxis, Metro Nashville")+
  mapTheme
```

- Broader context maps (e.g. whole city with venues and some basemap stuff?)

- Area maps for any geographic focus (e.g. North Nashville)